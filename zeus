#!/usr/bin/env bash

# Define some colours
RED="$(tput setaf 1)"
GREEN="$(tput setaf 2)"
YELLOW="$(tput setaf 3)"
RESET="$(tput sgr0)"

logo () {
  echo "zeus - the utility wrapper for docker, docker-compose, docker-machine and docker-machine-nfs"
  echo ""
}

usage () {
  logo

  cat <<EOF
Usage: $0 <command>

${YELLOW}Commands:${RESET}
  ${GREEN}init             ${RESET}Initialises Zeus and creates a Zeusfile
  ${GREEN}create           ${RESET}Creates the Docker machine for the first time
  ${GREEN}up               ${RESET}Starts the Docker containers
  ${GREEN}down             ${RESET}Removes the Docker containers
  ${GREEN}reload           ${RESET}Recreates the Docker containers
  ${GREEN}list             ${RESET}Lists Docker containers
  ${GREEN}ssh <container>  ${RESET}Connect via SSH to the specified container
  ${GREEN}info             ${RESET}Displays info for your Docker machine
EOF
  exit
}

echoError () {
  echo -e "${RED}$1 ${RESET}"
}

echoAbort () {
  echoError "$1\n\nAborting.."; exit 1;
}

echoSuccess () {
  echo -e "${GREEN}$1${RESET}"
}

checkMachineRunning () {
  machine_state=$(docker-machine ls | sed 1d | grep "^$1\s" | awk '{print $4}')

  if [ "Running" != "${machine_state}" ]; then
    echo "false"; return
  fi

  echo "true"
}

setPropDefaults () {
  # Gather the env vars we need to run.
  [ -f $PWD/Zeusfile ] && source $PWD/Zeusfile;
  [ -z "$ZEUS_NAME" ] && echoAbort "ZEUS_NAME missing. Please set in Zeusfile or ENV."
  [ -z "$ZEUS_DOMAIN" ] && echoAbort "Need to set ZEUS_DOMAIN. Please set in Zeusfile or ENV."
  [ -z "$ZEUS_SHELL" ] && ZEUS_SHELL="bash";
  [ -z "$ZEUS_VIRTUALBOX_MEMORY" ] && ZEUS_VIRTUALBOX_MEMORY="1024"

  [ "$(checkMachineRunning ${ZEUS_NAME})" = "true" ] && {
    ZEUS_MACHINE_RUNNING="yes"
  }
}

ensureCompatible () {
  # Check running on Darwin
  # [ "$(uname -s)" == "Darwin" ] || echo "Warning: zeus is for OS X only."

  # Check all required software is installed.
  for REQ_BINARY in docker docker-compose docker-machine docker-machine-nfs; do
    command -v "$REQ_BINARY" >/dev/null 2>&1 || {
      echoAbort "I require $REQ_BINARY but it's not installed."
    }
  done
}

zeusInit () {
  [ -f $PWD/Zeusfile ] && echoAbort "Zeusfile already exists."

  GUESSED_NAME=${PWD##*/}
  GUESSED_DOMAIN="$GUESSED_NAME.dev"

  read -p "What is your Docker project name? [$GUESSED_NAME] " ZEUS_NAME
  read -p "What is your Docker domain name? [$GUESSED_DOMAIN] " ZEUS_DOMAIN

  [ "$ZEUS_NAME" == "" ] && ZEUS_NAME="$GUESSED_NAME"
  [ "$ZEUS_DOMAIN" == "" ] && ZEUS_DOMAIN="$GUESSED_DOMAIN"

  cat >$PWD/Zeusfile <<EOL
# Automatically generated by zeus
ZEUS_NAME=$ZEUS_NAME
ZEUS_DOMAIN=$ZEUS_DOMAIN
EOL

  echoSuccess "Created Zeusfile!"
  exit
}

dockerEvalEnv () {
  [ -z "$ZEUS_MACHINE_RUNNING" ] && echoAbort "Machine ${ZEUS_NAME} does not exist."

  # We only want to eval once because it's a slow process.
  [ -z "$ZEUS_MACHINE_ACTIVE" ] && {
    eval $(docker-machine env ${ZEUS_NAME})
    ZEUS_MACHINE_ACTIVE="true"
  }
}

dockerCreate () {
  docker-machine create --driver virtualbox --virtualbox-memory ${ZEUS_VIRTUALBOX_MEMORY} ${ZEUS_NAME}
  docker-machine-nfs ${ZEUS_NAME}
  dockerInfo
}

dockerStart () {
  dockerEvalEnv

  echo "${YELLOW}Starting containers..${RESET}"
  docker-compose up -d
  echo "${GREEN}Started!${RESET}"
}

dockerStop () {
  dockerEvalEnv

  echo "${YELLOW}Removing containers..${RESET}"

  [[ $(docker-compose ps -q) ]] && docker-compose down;

  echo "${GREEN}Removed!${RESET}"
}

dockerInfo () {
  IP=$(docker-machine ip ${ZEUS_NAME})
  echo "${GREEN}The IP address for the virtual machine: ${IP}"
  echo ""
  echo "${GREEN}Please add a record in /etc/hosts file"
  echo ""
  echo "${YELLOW}  ${IP} ${ZEUS_DOMAIN}"
  echo "${RESET}"
}

dockerList () {
  dockerEvalEnv

  docker ps
}

dockerSsh () {
  CONTAINER="$1"
  if [[ "${CONTAINER}" == "" ]]; then
    echoAbort "You must provide a container name or ID. Run 'list' to identify your containers."
  fi

  dockerEvalEnv

  docker exec -it ${CONTAINER} ${ZEUS_SHELL}
}

[ $# -eq 0 ] && usage

[ "$1" == "init" ] && zeusInit

ensureCompatible
setPropDefaults

case "$1" in
	create)
    dockerCreate ;;
  up)
    dockerStart ;;
  down)
    dockerStop ;;
  reload)
    dockerStop && dockerStart ;;
  info)
    dockerInfo ;;
  list)
    dockerList ;;
  ssh)
    dockerSsh "$2" ;;
  *)
		usage ;;
esac
